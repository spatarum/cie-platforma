{% extends 'portal/base.html' %}

{% block title %}Panou | Platforma experți CIE{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h5 mb-0">{% if request.user.is_superuser %}Panou administrator{% else %}Panou staff{% endif %}</h1>
  {% if request.user.is_superuser %}
    <div class="d-flex gap-2">
      <a class="btn btn-primary btn-sm" href="{% url 'admin_chestionar_create' %}"><i class="bi bi-plus-lg me-1"></i>Chestionar nou</a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'admin_expert_create' %}"><i class="bi bi-person-plus me-1"></i>Expert nou</a>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'admin_staff_create' %}"><i class="bi bi-person-badge me-1"></i>Staff nou</a>
    </div>
  {% endif %}
</div>

<div class="card shadow-sm gov-card mb-4">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <strong><i class="bi bi-bar-chart-line me-1"></i>Capitole & foi de parcurs — statistică</strong>
    <a class="btn btn-sm btn-light" href="{% url 'admin_referinte' %}"><i class="bi bi-journal-bookmark me-1"></i>Deschide pagina</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="min-width: 420px;">Foaia de parcurs / Capitolul</th>
            <th class="text-end" style="width: 140px;">Experți alocați</th>
            <th class="text-end" style="width: 120px;">Chestionare</th>
            <th class="text-end" style="width: 170px;">Răspunsuri primite</th>
            <th class="text-end" style="width: 180px;">Rată medie de răspuns</th>
          </tr>
        </thead>
        <tbody>
          <tr class="table-secondary">
            <td colspan="5" class="fw-semibold"><i class="bi bi-flag me-1"></i>Foi de parcurs</td>
          </tr>
          {% if criterii_stats %}
            {% for r in criterii_stats %}
              <tr>
                <td>
                  <a class="text-decoration-none" href="{% url 'admin_criteriu_dashboard' r.obj.pk %}">
                    <span class="me-2" style="color: {{ r.obj.culoare_ui }};"><i class="bi {{ r.obj.pictograma|default:'bi-flag' }}"></i></span>
                    <span class="fw-semibold">{{ r.obj.cod }}</span> – {{ r.obj.denumire }}
                  </a>
                </td>
                <td class="text-end fw-semibold">{{ r.nr_experti }}</td>
                <td class="text-end">{{ r.nr_chestionare }}</td>
                <td class="text-end">{{ r.nr_raspunsuri }}</td>
                <td class="text-end">
                  <div class="d-flex flex-column align-items-end gap-1">
                    <div class="fw-semibold">{{ r.rata_medie_raspuns }}%</div>
                    <div class="progress w-100" style="height: 6px; max-width: 160px;">
                      <div class="progress-bar" role="progressbar" style="width: {{ r.rata_medie_raspuns }}%" aria-valuenow="{{ r.rata_medie_raspuns }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="text-muted">Nu există foi de parcurs definite.</td>
            </tr>
          {% endif %}

          <tr class="table-secondary">
            <td colspan="5" class="fw-semibold"><i class="bi bi-journal-text me-1"></i>Capitole (grupate pe clustere)</td>
          </tr>

          {% for cl, rows in grouped_chapter_stats %}
            <tr class="table-light">
              <td colspan="5" class="fw-semibold">
                {% if cl %}
                  <i class="bi {{ cl.pictograma|default:'bi-grid' }} me-1"></i>{{ cl.cod }}. {{ cl.denumire }}
                {% else %}
                  Capitole în afara clusterelor
                {% endif %}
              </td>
            </tr>

            {% for r in rows %}
              <tr>
                <td>
                  <a class="text-decoration-none" href="{% url 'admin_capitol_dashboard' r.obj.pk %}">
                    <span class="me-2" style="color: {{ r.obj.culoare_ui }};"><i class="bi {{ r.obj.pictograma|default:'bi-journal-text' }}"></i></span>
                    <span class="fw-semibold">Cap. {{ r.obj.numar }}</span> – {{ r.obj.denumire }}
                  </a>
                </td>
                <td class="text-end fw-semibold">{{ r.nr_experti }}</td>
                <td class="text-end">{{ r.nr_chestionare }}</td>
                <td class="text-end">{{ r.nr_raspunsuri }}</td>
                <td class="text-end">
                  <div class="d-flex flex-column align-items-end gap-1">
                    <div class="fw-semibold">{{ r.rata_medie_raspuns }}%</div>
                    <div class="progress w-100" style="height: 6px; max-width: 160px;">
                      <div class="progress-bar" role="progressbar" style="width: {{ r.rata_medie_raspuns }}%" aria-valuenow="{{ r.rata_medie_raspuns }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-muted">Nu există capitole în acest cluster.</td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer bg-white small text-muted">
    <strong>Notă:</strong>
    „Răspunsuri primite” reprezintă numărul de <em>chestionare trimise</em> (submisii cu status <code>TRIMIS</code>) asociate capitolului / foii de parcurs.
    Dacă același expert trimite 2 chestionare, acestea sunt numărate ca 2 răspunsuri.
    „Rată medie de răspuns” este media ratelor de răspuns ale chestionarelor din capitol / foaie de parcurs.
    Pentru chestionarele închise, procentul rămâne înghețat la termenul limită.
    Ciornele nu sunt incluse.
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm gov-card">
      <div class="card-body">
        <div class="d-flex align-items-center gap-2 mb-3">
          <i class="bi bi-people fs-4"></i>
          <div>
            <div class="text-muted small">Experți înregistrați</div>
            <div class="fs-4 fw-semibold">{{ nr_experti }}</div>
          </div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <div class="text-muted small">Total chestionare</div>
            <div class="fw-semibold">{{ nr_chestionare_total }}</div>
          </div>
          <div class="col-6">
            <div class="text-muted small">Rată globală de răspuns</div>
            <div class="fw-semibold">{{ rata_globala }}%</div>
          </div>
          <div class="col-12">
            <div class="progress" style="height: 6px;">
              <div class="progress-bar" role="progressbar" style="width: {{ rata_globala }}%" aria-valuenow="{{ rata_globala }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="text-muted small mt-2">Rată globală = media ratelor medii pe capitole.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm gov-card">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <strong><i class="bi bi-ui-checks-grid me-1"></i>Chestionare recente</strong>
        <a class="btn btn-sm btn-light" href="{% url 'admin_chestionare_list' %}">Vezi toate</a>
      </div>
      <div class="card-body">
        {% if chestionare %}
          <div class="list-group list-group-flush">
            {% for c in chestionare %}
              <a class="list-group-item list-group-item-action" href="{% url 'admin_chestionar_edit' c.pk %}">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="fw-semibold">{{ c.titlu }}</div>
                    <div class="text-muted small">Termen: {{ c.termen_limita|date:"d.m.Y H:i" }}</div>
                  </div>
                  <span class="badge text-bg-light">ID {{ c.id }}</span>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">Nu există chestionare încă.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if request.user.is_superuser %}
  <div class="mt-4 small text-muted">
    Pentru administrare avansată (utilizatori, modele, etc.) poți folosi și interfața Django Admin: <a href="/django-admin/" target="_blank">/django-admin/</a>
  </div>
{% endif %}
{% endblock %}
