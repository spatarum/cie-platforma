{% extends 'portal/base.html' %}

{% block title %}{{ chestionar.titlu }} | Platforma experți CIE{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between mb-3">
  <div>
    <h1 class="h5 mb-1">{{ chestionar.titlu }}</h1>
    {% if chestionar.descriere %}<div class="text-muted">{{ chestionar.descriere }}</div>{% endif %}
    <div class="mt-2 d-flex flex-wrap gap-2">
      {% if chestionar.este_general %}
        <span class="badge text-bg-primary"><i class="bi bi-megaphone me-1"></i>General (pentru toți experții)</span>
      {% endif %}
      {% for ch in chestionar.capitole.all %}
        <span class="badge text-bg-light"><i class="bi {{ ch.pictograma|default:'bi-journal-text' }} me-1"></i>Cap. {{ ch.numar }} – {{ ch.denumire }}</span>
      {% endfor %}
      {% for cr in chestionar.criterii.all %}
        <span class="badge text-bg-light"><i class="bi {{ cr.pictograma|default:'bi-flag' }} me-1"></i>{{ cr.denumire }}</span>
      {% endfor %}
    </div>
  </div>
  <div class="text-end">
    <div class="small text-muted">Termen limită</div>
    <div class="fw-semibold">{{ chestionar.termen_limita|date:"d.m.Y H:i" }}</div>
    {% if editabil %}
      <span class="badge text-bg-success mt-2">Deschis</span>
    {% else %}
      <span class="badge text-bg-secondary mt-2">Închis</span>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm gov-card">
  <div class="card-body">
    {% if not editabil %}
      <div class="alert alert-secondary">
        <i class="bi bi-lock me-1"></i>Termenul limită a expirat. Poți doar să vizualizezi răspunsurile.
      </div>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      {{ form.non_field_errors }}

      {% for field in form %}
        <div class="mb-3">
          <label class="form-label fw-semibold">{{ field.label }}</label>
          {{ field }}
          {{ field.errors }}
          <div class="small text-muted d-flex justify-content-between">
            <span>Maxim 3000 caractere.</span>
            <span class="char-counter" data-for="{{ field.id_for_label }}"></span>
          </div>
        </div>
      {% endfor %}

      <div class="d-flex flex-wrap gap-2 mt-4">
        {% if editabil %}
          <button class="btn btn-outline-primary" name="actiune" value="salveaza" type="submit">
            <i class="bi bi-save me-1"></i>Salvează ciornă
          </button>
          <button class="btn btn-primary" name="actiune" value="trimite" type="submit">
            <i class="bi bi-send me-1"></i>Trimite răspunsurile
          </button>
        {% endif %}
        <a class="btn btn-light" href="{% url 'expert_dashboard' %}"><i class="bi bi-arrow-left me-1"></i>Înapoi</a>

        <div class="ms-auto align-self-center">
          {% if submission.status == 'TRIMIS' %}
            <span class="badge text-bg-primary">Trimis</span>
          {% else %}
            <span class="badge text-bg-secondary">Ciornă</span>
          {% endif %}
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Bootstrap styling for textarea fields
  document.querySelectorAll('textarea').forEach((t) => {
    t.classList.add('form-control');
    t.setAttribute('maxlength', '3000');
    if ({{ editabil|yesno:"true,false" }} === false) {
      t.setAttribute('disabled', 'disabled');
    }
  });

  function updateCounter(textarea) {
    const max = 3000;
    const len = textarea.value.length;
    const remaining = max - len;
    const counter = document.querySelector(`.char-counter[data-for='${textarea.id}']`);
    if(counter) counter.textContent = `${remaining} rămase`;
  }

  document.querySelectorAll('textarea').forEach((t) => {
    updateCounter(t);
    t.addEventListener('input', () => updateCounter(t));
  });
</script>
{% endblock %}
